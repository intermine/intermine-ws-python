<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>intermine.query &mdash; Intermine 1.10.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.10.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Intermine 1.10.0 documentation" href="../../query.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for intermine.query</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span><span class="p">,</span> <span class="n">getDOMImplementation</span>

<span class="kn">from</span> <span class="nn">intermine.util</span> <span class="kn">import</span> <span class="n">openAnything</span><span class="p">,</span> <span class="n">ReadableException</span>
<span class="kn">from</span> <span class="nn">intermine.pathfeatures</span> <span class="kn">import</span> <span class="n">PathDescription</span><span class="p">,</span> <span class="n">Join</span><span class="p">,</span> <span class="n">SortOrder</span><span class="p">,</span> <span class="n">SortOrderList</span>
<span class="kn">from</span> <span class="nn">intermine.model</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Class</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reference</span><span class="p">,</span> <span class="n">ConstraintNode</span>

<span class="kn">import</span> <span class="nn">intermine.constraints</span> <span class="k">as</span> <span class="nn">constraints</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes representing queries against webservices</span>
<span class="sd">================================================</span>

<span class="sd">Representations of queries, and templates.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Alex Kalderimis&quot;</span>
<span class="n">__organization__</span> <span class="o">=</span> <span class="s2">&quot;InterMine&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;LGPL&quot;</span>
<span class="n">__contact__</span> <span class="o">=</span> <span class="s2">&quot;dev@intermine.org&quot;</span>

<span class="n">LOGIC_OPS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">]</span>
<span class="n">LOGIC_PRODUCT</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">LOGIC_OPS</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">LOGIC_OPS</span><span class="p">]</span>

<div class="viewcode-block" id="Query"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query">[docs]</a><span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Class representing a structured database query</span>
<span class="sd">    ================================================</span>

<span class="sd">    Objects of this class have properties that model the</span>
<span class="sd">    attributes of the query, and methods for performing</span>
<span class="sd">    the request.</span>

<span class="sd">    SYNOPSIS</span>
<span class="sd">    --------</span>

<span class="sd">    example:</span>

<span class="sd">        &gt;&gt;&gt; service = Service(&quot;http://www.flymine.org/query/service&quot;)</span>
<span class="sd">        &gt;&gt;&gt; query = service.new_query()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; query.add_view(&quot;Gene.symbol&quot;, &quot;Gene.pathways.name&quot;, &quot;Gene.proteins.symbol&quot;)</span>
<span class="sd">        &gt;&gt;&gt; query.add_sort_order(&quot;Gene.pathways.name&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; query.add_constraint(&quot;Gene&quot;, &quot;LOOKUP&quot;, &quot;eve&quot;)</span>
<span class="sd">        &gt;&gt;&gt; query.add_constraint(&quot;Gene.pathways.name&quot;, &quot;=&quot;, &quot;Phosphate*&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; query.set_logic(&quot;A or B&quot;)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; for row in query.rows():</span>
<span class="sd">        ...     handle_row(row)</span>

<span class="sd">    OR, using an SQL style DSL:</span>

<span class="sd">        &gt;&gt;&gt; s = Service(&quot;www.flymine.org/query&quot;)</span>
<span class="sd">        &gt;&gt;&gt; query = s.query(&quot;Gene&quot;).\\</span>
<span class="sd">        ...           select(&quot;*&quot;, &quot;pathways.*&quot;).\\</span>
<span class="sd">        ...           where(&quot;symbol&quot;, &quot;=&quot;, &quot;H&quot;).\\</span>
<span class="sd">        ...           outerjoin(&quot;pathways&quot;).\\</span>
<span class="sd">        ...           order_by(&quot;symbol&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for row in query.rows(start=10, size=5):</span>
<span class="sd">        ...     handle_row(row)</span>

<span class="sd">    OR, for a more SQL-alchemy, ORM style:</span>

<span class="sd">        &gt;&gt;&gt; for gene in s.query(s.model.Gene).filter(s.model.Gene.symbol == [&quot;zen&quot;, &quot;H&quot;, &quot;eve&quot;]).add_columns(s.model.Gene.alleles):</span>
<span class="sd">        ...    handle(gene)</span>

<span class="sd">    Query objects represent structured requests for information over the database</span>
<span class="sd">    housed at the datawarehouse whose webservice you are querying. They utilise</span>
<span class="sd">    some of the concepts of relational databases, within an object-related</span>
<span class="sd">    ORM context. If you don&#39;t know what that means, don&#39;t worry: you</span>
<span class="sd">    don&#39;t need to write SQL, and the queries will be fast.</span>

<span class="sd">    To make things slightly more familiar to those with knowledge of SQL, some syntactical</span>
<span class="sd">    sugar is provided to make constructing queries a bit more recognisable.</span>

<span class="sd">    PRINCIPLES</span>
<span class="sd">    ----------</span>

<span class="sd">    The data model represents tables in the databases as classes, with records</span>
<span class="sd">    within tables as instances of that class. The columns of the database are the</span>
<span class="sd">    fields of that object::</span>

<span class="sd">      The Gene table - showing two records/objects</span>
<span class="sd">      +---------------------------------------------------+</span>
<span class="sd">      | id  | symbol  | length | cyto-location | organism |</span>
<span class="sd">      +----------------------------------------+----------+</span>
<span class="sd">      | 01  | eve     | 1539   | 46C10-46C10   |  01      |</span>
<span class="sd">      +----------------------------------------+----------+</span>
<span class="sd">      | 02  | zen     | 1331   | 84A5-84A5     |  01      |</span>
<span class="sd">      +----------------------------------------+----------+</span>
<span class="sd">      ...</span>

<span class="sd">      The organism table - showing one record/object</span>
<span class="sd">      +----------------------------------+</span>
<span class="sd">      | id  | name            | taxon id |</span>
<span class="sd">      +----------------------------------+</span>
<span class="sd">      | 01  | D. melanogaster | 7227     |</span>
<span class="sd">      +----------------------------------+</span>

<span class="sd">    Columns that contain a meaningful value are known as &#39;attributes&#39; (in the tables above, that is</span>
<span class="sd">    everything except the id columns). The other columns (such as &quot;organism&quot; in the gene table)</span>
<span class="sd">    are ones that reference records of other tables (ie. other objects), and are called</span>
<span class="sd">    references. You can refer to any field in any class, that has a connection,</span>
<span class="sd">    however tenuous, with a table, by using dotted path notation::</span>

<span class="sd">      Gene.organism.name -&gt; the name column in the organism table, referenced by a record in the gene table</span>

<span class="sd">    These paths, and the connections between records and tables they represent,</span>
<span class="sd">    are the basis for the structure of InterMine queries.</span>

<span class="sd">    THE STUCTURE OF A QUERY</span>
<span class="sd">    -----------------------</span>

<span class="sd">    A query has two principle sets of properties:</span>
<span class="sd">      - its view: the set of output columns</span>
<span class="sd">      - its constraints: the set of rules for what to include</span>

<span class="sd">    A query must have at least one output column in its view, but constraints</span>
<span class="sd">    are optional - if you don&#39;t include any, you will get back every record</span>
<span class="sd">    from the table (every object of that type)</span>

<span class="sd">    In addition, the query must be coherent: if you have information about</span>
<span class="sd">    an organism, and you want a list of genes, then the &quot;Gene&quot; table</span>
<span class="sd">    should be the basis for your query, and as such the Gene class, which</span>
<span class="sd">    represents this table, should be the root of all the paths that appear in it:</span>

<span class="sd">    So, to take a simple example::</span>

<span class="sd">        I have an organism name, and I want a list of genes:</span>

<span class="sd">    The view is the list of things I want to know about those genes:</span>

<span class="sd">        &gt;&gt;&gt; query.add_view(&quot;Gene.name&quot;)</span>
<span class="sd">        &gt;&gt;&gt; query.add_view(&quot;Gene.length&quot;)</span>
<span class="sd">        &gt;&gt;&gt; query.add_view(&quot;Gene.proteins.sequence.length&quot;)</span>

<span class="sd">    Note I can freely mix attributes and references, as long as every view ends in</span>
<span class="sd">    an attribute (a meaningful value). As a short-cut I can also write:</span>

<span class="sd">        &gt;&gt;&gt; query.add_views(&quot;Gene.name&quot;, &quot;Gene.length&quot;, &quot;Gene.proteins.sequence.length&quot;)</span>

<span class="sd">    or:</span>

<span class="sd">        &gt;&gt;&gt; query.add_views(&quot;Gene.name Gene.length Gene.proteins.sequence.length&quot;)</span>

<span class="sd">    They are all equivalent. You can also use common SQL style shortcuts such as &quot;*&quot; for all</span>
<span class="sd">    attribute fields:</span>

<span class="sd">        &gt;&gt;&gt; query.add_views(&quot;Gene.*&quot;)</span>

<span class="sd">    You can also use &quot;select&quot; as a synonymn for &quot;add_view&quot;</span>

<span class="sd">    Now I can add my constraints. As, we mentioned, I have information about an organism, so:</span>

<span class="sd">        &gt;&gt;&gt; query.add_constraint(&quot;Gene.organism.name&quot;, &quot;=&quot;, &quot;D. melanogaster&quot;)</span>

<span class="sd">    (note, here I can use &quot;where&quot; as a synonymn for &quot;add_constraint&quot;)</span>

<span class="sd">    If I run this query, I will get literally millions of results -</span>
<span class="sd">    it needs to be filtered further:</span>

<span class="sd">        &gt;&gt;&gt; query.add_constraint(&quot;Gene.proteins.sequence.length&quot;, &quot;&lt;&quot;, 500)</span>

<span class="sd">    If that doesn&#39;t restrict things enough I can add more filters:</span>

<span class="sd">        &gt;&gt;&gt; query.add_constraint(&quot;Gene.symbol&quot;, &quot;ONE OF&quot;, [&quot;eve&quot;, &quot;zen&quot;, &quot;h&quot;])</span>

<span class="sd">    Now I am guaranteed to get only information on genes I am interested in.</span>

<span class="sd">    Note, though, that because I have included the link (or &quot;join&quot;) from Gene -&gt; Protein,</span>
<span class="sd">    this, by default, means that I only want genes that have protein information associated</span>
<span class="sd">    with them. If in fact I want information on all genes, and just want to know the</span>
<span class="sd">    protein information if it is available, then I can specify that with:</span>

<span class="sd">        &gt;&gt;&gt; query.add_join(&quot;Gene.proteins&quot;, &quot;OUTER&quot;)</span>

<span class="sd">    And if perhaps my query is not as simple as a strict cumulative filter, but I want all</span>
<span class="sd">    D. mel genes that EITHER have a short protein sequence OR come from one of my favourite genes</span>
<span class="sd">    (as unlikely as that sounds), I can specify the logic for that too:</span>

<span class="sd">        &gt;&gt;&gt; query.set_logic(&quot;A and (B or C)&quot;)</span>

<span class="sd">    Each letter refers to one of the constraints - the codes are assigned in the order you add</span>
<span class="sd">    the constraints. If you want to be absolutely certain about the constraints you mean, you</span>
<span class="sd">    can use the constraint objects themselves:</span>

<span class="sd">      &gt;&gt;&gt; gene_is_eve = query.add_constraint(&quot;Gene.symbol&quot;, &quot;=&quot;, &quot;eve&quot;)</span>
<span class="sd">      &gt;&gt;&gt; gene_is_zen = query.add_constraint(&quot;Gene.symbol&quot;, &quot;=&quot;, &quot;zne&quot;)</span>
<span class="sd">      &gt;&gt;&gt;</span>
<span class="sd">      &gt;&gt;&gt; query.set_logic(gene_is_eve | gene_is_zen)</span>

<span class="sd">    By default the logic is a straight cumulative filter (ie: A and B and C and D  and ...)</span>

<span class="sd">    Putting it all together:</span>

<span class="sd">       &gt;&gt;&gt; query.add_view(&quot;Gene.name&quot;, &quot;Gene.length&quot;, &quot;Gene.proteins.sequence.length&quot;)</span>
<span class="sd">       &gt;&gt;&gt; query.add_constraint(&quot;Gene.organism.name&quot;, &quot;=&quot;, &quot;D. melanogaster&quot;)</span>
<span class="sd">       &gt;&gt;&gt; query.add_constraint(&quot;Gene.proteins.sequence.length&quot;, &quot;&lt;&quot;, 500)</span>
<span class="sd">       &gt;&gt;&gt; query.add_constraint(&quot;Gene.symbol&quot;, &quot;ONE OF&quot;, [&quot;eve&quot;, &quot;zen&quot;, &quot;h&quot;])</span>
<span class="sd">       &gt;&gt;&gt; query.add_join(&quot;Gene.proteins&quot;, &quot;OUTER&quot;)</span>
<span class="sd">       &gt;&gt;&gt; query.set_logic(&quot;A and (B or C)&quot;)</span>

<span class="sd">    This can be made more concise and readable with a little DSL sugar:</span>

<span class="sd">        &gt;&gt;&gt; query = service.query(&quot;Gene&quot;)</span>
<span class="sd">        &gt;&gt;&gt; query.select(&quot;name&quot;, &quot;length&quot;, &quot;proteins.sequence.length&quot;).\</span>
<span class="sd">        ...       where(&#39;organism.name&#39; &#39;=&#39;, &#39;D. melanogaster&#39;).\</span>
<span class="sd">        ...       where(&quot;proteins.sequence.length&quot;, &quot;&lt;&quot;, 500).\</span>
<span class="sd">        ...       where(&#39;symbol&#39;, &#39;ONE OF&#39;, [&#39;eve&#39;, &#39;h&#39;, &#39;zen&#39;]).\</span>
<span class="sd">        ...       outerjoin(&#39;proteins&#39;).\</span>
<span class="sd">        ...       set_logic(&quot;A and (B or C)&quot;)</span>

<span class="sd">    And the query is defined.</span>

<span class="sd">    Result Processing: Rows</span>
<span class="sd">    -----------------------</span>

<span class="sd">    calling &quot;.rows()&quot; on a query will return an iterator of rows, where each row</span>
<span class="sd">    is a ResultRow object, which can be treated as both a list and a dictionary.</span>

<span class="sd">    Which means you can refer to columns by name:</span>

<span class="sd">        &gt;&gt;&gt; for row in query.rows():</span>
<span class="sd">        ...     print &quot;name is %s&quot; % (row[&quot;name&quot;])</span>
<span class="sd">        ...     print &quot;length is %d&quot; % (row[&quot;length&quot;])</span>

<span class="sd">    As well as using list indices:</span>

<span class="sd">        &gt;&gt;&gt; for row in query.rows():</span>
<span class="sd">        ...     print &quot;The first column is %s&quot; % (row[0])</span>

<span class="sd">    Iterating over a row iterates over the cell values as a list:</span>

<span class="sd">        &gt;&gt;&gt; for row in query.rows():</span>
<span class="sd">        ...     for column in row:</span>
<span class="sd">        ...         do_something(column)</span>

<span class="sd">    Here each row will have a gene name, a gene length, and a sequence length, eg:</span>

<span class="sd">        &gt;&gt;&gt; print row.to_l</span>
<span class="sd">        [&quot;even skipped&quot;, &quot;1359&quot;, &quot;376&quot;]</span>

<span class="sd">    To make that clearer, you can ask for a dictionary instead of a list:</span>

<span class="sd">        &gt;&gt;&gt; for row in query.rows()</span>
<span class="sd">        ...       print row.to_d</span>
<span class="sd">        {&quot;Gene.name&quot;:&quot;even skipped&quot;,&quot;Gene.length&quot;:&quot;1359&quot;,&quot;Gene.proteins.sequence.length&quot;:&quot;376&quot;}</span>


<span class="sd">    If you just want the raw results, for printing to a file, or for piping to another program,</span>
<span class="sd">    you can request the results in one of these formats: json&#39;, &#39;rr&#39;, &#39;tsv&#39;, &#39;jsonobjects&#39;, &#39;jsonrows&#39;, &#39;list&#39;, &#39;dict&#39;, &#39;csv&#39;</span>

<span class="sd">        &gt;&gt;&gt; for row in query.result(&quot;&lt;format name&gt;&quot;, size = &lt;size&gt;)</span>
<span class="sd">        ...     print(row)</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Result Processing: Results</span>
<span class="sd">    --------------------------</span>

<span class="sd">    Results can also be processing on a record by record basis. If you have a query that</span>
<span class="sd">    has output columns of &quot;Gene.symbol&quot;, &quot;Gene.pathways.name&quot; and &quot;Gene.proteins.proteinDomains.primaryIdentifier&quot;,</span>
<span class="sd">    than processing it by records will return one object per gene, and that gene will have a property</span>
<span class="sd">    named &quot;pathways&quot; which contains objects which have a name property. Likewise there will be a</span>
<span class="sd">    proteins property which holds a list of proteinDomains which all have a primaryIdentifier property, and so on.</span>
<span class="sd">    This allows a more object orientated approach to database records, familiar to users of</span>
<span class="sd">    other ORMs.</span>

<span class="sd">    This is the format used when you choose to iterate over a query directly, or can be explicitly</span>
<span class="sd">    chosen by invoking L{intermine.query.Query.results}:</span>

<span class="sd">        &gt;&gt;&gt; for gene in query:</span>
<span class="sd">        ...    print gene.name, map(lambda x: x.name, gene.pathways)</span>

<span class="sd">    The structure of the object and the information it contains depends entirely</span>
<span class="sd">    on the output columns selected. The values may be None, of course, but also any valid values of an object</span>
<span class="sd">    (according to the data model) will also be None if they were not selected for output. Attempts</span>
<span class="sd">    to access invalid properties (such as gene.favourite_colour) will cause exceptions to be thrown.</span>

<span class="sd">    Getting us to Generate your Code</span>
<span class="sd">    --------------------------------</span>

<span class="sd">    Not that you have to actually write any of this! The webapp will happily</span>
<span class="sd">    generate the code for any query (and template) you can build in it. A good way to get</span>
<span class="sd">    started is to use the webapp to generate your code, and then run it as scripts</span>
<span class="sd">    to speed up your queries. You can always tinker with and edit the scripts you download.</span>

<span class="sd">    To get generated queries, look for the &quot;python&quot; link at the bottom of query-builder and</span>
<span class="sd">    template form pages, it looks a bit like this::</span>

<span class="sd">      . +=====================================+=============</span>
<span class="sd">        |                                     |</span>
<span class="sd">        |    Perl  |  Python  |  Java [Help]  |</span>
<span class="sd">        |                                     |</span>
<span class="sd">        +==============================================</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SO_SPLIT_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\s*(asc|desc)\s*&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="n">LOGIC_SPLIT_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\s*(?:and|or|\(|\))\s*&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="n">TRAILING_OP_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\s*(and|or)\s*$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="n">LEADING_OP_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^\s*(and|or)\s*&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
    <span class="n">ORPHANED_OP_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(?:\(\s*(?:and|or)\s*|\s*(?:and|or)\s*\))&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a new Query</span>
<span class="sd">        =====================</span>

<span class="sd">        Construct a new query for making database queries</span>
<span class="sd">        against an InterMine data warehouse.</span>

<span class="sd">        Normally you would not need to use this constructor</span>
<span class="sd">        directly, but instead use the factory method on</span>
<span class="sd">        intermine.webservice.Service, which will handle construction</span>
<span class="sd">        for you.</span>

<span class="sd">        @param model: an instance of L{intermine.model.Model}. Required</span>
<span class="sd">        @param service: an instance of l{intermine.service.Service}. Optional,</span>
<span class="sd">            but you will not be able to make requests without one.</span>
<span class="sd">        @param validate: a boolean - defaults to True. If set to false, the query</span>
<span class="sd">            will not try and validate itself. You should not set this to false.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">.</span><span class="n">root</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_depth</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">prefetch_depth</span> <span class="k">if</span> <span class="n">service</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_id_only</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">prefetch_id_only</span> <span class="k">if</span> <span class="n">service</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span> <span class="o">=</span> <span class="n">validate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uncoded_constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span> <span class="o">=</span> <span class="n">SortOrderList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logic_parser</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">LogicParser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_factory</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">ConstraintFactory</span><span class="p">()</span>

        <span class="c1"># Set up sugary aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">where</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_views</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_sort_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarise</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over all the objects returned by this query&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="s2">&quot;jsonobjects&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of rows this query will return.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a new list from the symmetric difference of these things&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_list_manager</span><span class="o">.</span><span class="n">subtract</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="n">other</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__xor__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the symmetric difference of this query and another&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_list_manager</span><span class="o">.</span><span class="n">xor</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Intersect this query and another query or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_list_manager</span><span class="o">.</span><span class="n">intersect</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the union of this query and another query or list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_list_manager</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the union of this query and another query or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_list_manager</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Query.from_xml"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.from_xml">[docs]</a>    <span class="k">def</span> <span class="nf">from_xml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deserialise a query serialised to XML</span>
<span class="sd">        =====================================</span>

<span class="sd">        This method is used to instantiate serialised queries.</span>
<span class="sd">        It is used by intermine.webservice.Service objects</span>
<span class="sd">        to instantiate Template objects and it can be used</span>
<span class="sd">        to read in queries you have saved to a file.</span>

<span class="sd">        @param xml: The xml as a file name, url, or string</span>

<span class="sd">        @raise QueryParseError: if the query cannot be parsed</span>
<span class="sd">        @raise ModelError: if the query has illegal paths in it</span>
<span class="sd">        @raise ConstraintError: if the constraints don&#39;t make sense</span>

<span class="sd">        @rtype: L{Query}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">do_verification</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">openAnything</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">queries</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">QueryParseError</span><span class="p">(</span><span class="s2">&quot;wrong number of queries in xml. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Only one &lt;query&gt; element is allowed. Found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">queries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;pathDescription&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;pathString&#39;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">add_path_description</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;constraint&#39;</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">parentNode</span><span class="o">.</span><span class="n">tagName</span> <span class="o">!=</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Constraints must have a path&quot;</span>
                    <span class="k">raise</span> <span class="n">QueryParseError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">parentNode</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;op&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;subclass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;editable&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;switchable&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;extra_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;extraValue&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;loopPath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;loopPath&#39;</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">val_e</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">val_e</span><span class="o">.</span><span class="n">childNodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">nodeType</span> <span class="o">==</span> <span class="n">node</span><span class="o">.</span><span class="n">TEXT_NODE</span><span class="p">:</span> <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;loopPath&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;=&quot;</span> <span class="p">:</span> <span class="s2">&quot;IS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;!=&quot;</span><span class="p">:</span> <span class="s2">&quot;IS NOT&quot;</span>
                <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">])</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">con</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;error adding constraint with args: &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
            <span class="n">itr</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">next</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;sortOrder&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sos</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">SO_SPLIT_PATTERN</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;sortOrder&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sos</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">views</span><span class="p">:</span> <span class="c1"># Be tolerant of irrelevant sort-orders</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">add_sort_order</span><span class="p">(</span><span class="n">sos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sos</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c1"># Get rid of empty string at end</span>
                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">group</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">views</span><span class="p">:</span> <span class="c1"># Be tolerant of irrelevant so.</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">add_sort_order</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;constraintLogic&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_set_questionable_logic</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;constraintLogic&#39;</span><span class="p">))</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="nf">_set_questionable_logic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">questionable_logic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempts to sanity check the logic argument before it is set&quot;&quot;&quot;</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">questionable_logic</span>
        <span class="n">used_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">logic_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Query</span><span class="o">.</span><span class="n">LOGIC_SPLIT_PATTERN</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">questionable_logic</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">in</span> <span class="n">logic_codes</span><span class="p">:</span>
            <span class="n">logic_codes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">irrelevant_codes</span> <span class="o">=</span> <span class="n">logic_codes</span> <span class="o">-</span> <span class="n">used_codes</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">irrelevant_codes</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            <span class="n">logic</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="c1"># Remove empty groups</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;\((:?and|or|\s)*\)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="c1"># Remove trailing and leading operators</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">LEADING_OP_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">TRAILING_OP_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="c1"># repeat, as this process can leave doubles</span>
            <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">LOGIC_PRODUCT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">:</span>
                    <span class="n">repl</span> <span class="o">=</span> <span class="n">left</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">repl</span> <span class="o">=</span> <span class="s2">&quot;and&quot;</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="s2">&quot;\s*&quot;</span> <span class="o">+</span> <span class="n">right</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
                <span class="n">logic</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">ORPHANED_OP_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;(&quot;</span> <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">LEADING_OP_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">TRAILING_OP_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">logic</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">logic</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_logic</span><span class="p">(</span><span class="n">logic</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error parsing logic string &quot;</span>
                <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">questionable_logic</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot; (which is &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">logic</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; after irrelevant codes have been removed)&quot;</span>
                <span class="o">+</span> <span class="s2">&quot; with available codes: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">used_codes</span><span class="p">))</span>
                <span class="o">+</span> <span class="s2">&quot; because: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the XML serialisation of this query&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>

<div class="viewcode-block" id="Query.verify"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the query</span>
<span class="sd">        ==================</span>

<span class="sd">        Invalid queries will fail to run, and it is not always</span>
<span class="sd">        obvious why. The validation routine checks to see that</span>
<span class="sd">        the query will not cause errors on execution, and tries to</span>
<span class="sd">        provide informative error messages.</span>

<span class="sd">        This method is called immediately after a query is fully</span>
<span class="sd">        deserialised.</span>

<span class="sd">        @raise ModelError: if the paths are invalid</span>
<span class="sd">        @raise QueryError: if there are errors in query construction</span>
<span class="sd">        @raise ConstraintError: if there are errors in constraint construction</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_views</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_constraint_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_join_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_pd_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_sort_order</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Query.select"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace the current selection of output columns with this one</span>
<span class="sd">        =============================================================</span>

<span class="sd">        example::</span>

<span class="sd">           query.select(&quot;*&quot;, &quot;proteins.name&quot;)</span>

<span class="sd">        This method is intended to provide an API familiar to those</span>
<span class="sd">        with experience of SQL or other ORM layers. This method, in</span>
<span class="sd">        contrast to other view manipulation methods, replaces</span>
<span class="sd">        the selection of output columns, rather than appending to it.</span>

<span class="sd">        Note that any sort orders that are no longer in the view will</span>
<span class="sd">        be removed.</span>

<span class="sd">        @param paths: The output columns to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">so_elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span> <span class="o">=</span> <span class="n">SortOrderList</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">so_elems</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">so</span><span class="o">.</span><span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">so</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Query.add_view"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.add_view">[docs]</a>    <span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add one or more views to the list of output columns</span>
<span class="sd">        ===================================================</span>

<span class="sd">        example::</span>

<span class="sd">            query.add_view(&quot;Gene.name Gene.organism.name&quot;)</span>

<span class="sd">        This is the main method for adding views to the list</span>
<span class="sd">        of output columns. As well as appending views, it</span>
<span class="sd">        will also split a single, space or comma delimited</span>
<span class="sd">        string into multiple paths, and flatten out lists, or any</span>
<span class="sd">        combination. It will also immediately try to validate</span>
<span class="sd">        the views.</span>

<span class="sd">        Output columns must be valid paths according to the</span>
<span class="sd">        data model, and they must represent attributes of tables</span>

<span class="sd">        Also available as:</span>
<span class="sd">         - add_views</span>
<span class="sd">         - add_column</span>
<span class="sd">         - add_columns</span>
<span class="sd">         - add_to_select</span>

<span class="sd">        @see: intermine.model.Model</span>
<span class="sd">        @see: intermine.model.Path</span>
<span class="sd">        @see: intermine.model.Attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">views</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Class</span><span class="p">):</span>
                <span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">_path</span><span class="o">.</span><span class="n">is_attribute</span><span class="p">():</span>
                    <span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Reference</span><span class="p">):</span>
                <span class="n">views</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">views</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(?:,?\s+|,)&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>

        <span class="n">views</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">,</span> <span class="n">views</span><span class="p">))</span>

        <span class="n">views_to_add</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">):</span>
                <span class="n">view</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;\.\*$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
                <span class="n">scd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">()</span>
                <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">id_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">scd</span><span class="p">)</span>
                        <span class="n">cd</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">end_class</span>
                        <span class="n">add_f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span>
                        <span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="s2">&quot;.id&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">id_only</span> <span class="ow">and</span> <span class="n">cd</span><span class="o">.</span><span class="n">has_id</span> <span class="k">else</span> <span class="p">[</span><span class="n">add_f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">attributes</span><span class="p">]</span>
                        <span class="n">next_level</span> <span class="o">=</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">rs_and_cs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cd</span><span class="o">.</span><span class="n">references</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">cd</span><span class="o">.</span><span class="n">collections</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rs_and_cs</span><span class="p">:</span>
                            <span class="n">rp</span> <span class="o">=</span> <span class="n">add_f</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">next_level</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
                            <span class="n">vs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expand</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">next_level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_id_only</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">vs</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">[]</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_depth</span>
                <span class="n">views_to_add</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">expand</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">depth</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">views_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verify_views</span><span class="p">(</span><span class="n">views_to_add</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">views_to_add</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Query.prefix_path"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.prefix_path">[docs]</a>    <span class="k">def</span> <span class="nf">prefix_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span><span class="p">:</span> <span class="c1"># eg. not when building from XML</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">):</span>
                    <span class="n">trimmed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;\.\*$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trimmed</span> <span class="o">=</span> <span class="n">path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">trimmed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span><span class="o">.</span><span class="n">root</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">path</span></div>

<div class="viewcode-block" id="Query.clear_view"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.clear_view">[docs]</a>    <span class="k">def</span> <span class="nf">clear_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the output column list</span>
<span class="sd">        ============================</span>

<span class="sd">        Deletes all entries currently in the view list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Query.verify_views"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.verify_views">[docs]</a>    <span class="k">def</span> <span class="nf">verify_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">views</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check to see if the views given are valid</span>
<span class="sd">        =========================================</span>

<span class="sd">        This method checks to see if the views:</span>
<span class="sd">          - are valid according to the model</span>
<span class="sd">          - represent attributes</span>

<span class="sd">        @see: L{intermine.model.Attribute}</span>

<span class="sd">        @raise intermine.model.ModelError: if the paths are invalid</span>
<span class="sd">        @raise ConstraintError: if the paths are not attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">views</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">views</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_attribute</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;&#39; does not represent an attribute&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.add_constraint"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.add_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a constraint (filter on records)</span>
<span class="sd">        ====================================</span>

<span class="sd">        example::</span>

<span class="sd">            query.add_constraint(&quot;Gene.symbol&quot;, &quot;=&quot;, &quot;zen&quot;)</span>

<span class="sd">        This method will try to make a constraint from the arguments</span>
<span class="sd">        given, trying each of the classes it knows of in turn</span>
<span class="sd">        to see if they accept the arguments. This allows you</span>
<span class="sd">        to add constraints of different types without having to know</span>
<span class="sd">        or care what their classes or implementation details are.</span>
<span class="sd">        All constraints derive from intermine.constraints.Constraint,</span>
<span class="sd">        and they all have a path attribute, but are otherwise diverse.</span>

<span class="sd">        Before adding the constraint to the query, this method</span>
<span class="sd">        will also try to check that the constraint is valid by</span>
<span class="sd">        calling Query.verify_constraint_paths()</span>

<span class="sd">        @see: L{intermine.constraints}</span>

<span class="sd">        @rtype: L{intermine.constraints.Constraint}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">con</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_factory</span><span class="o">.</span><span class="n">make_constraint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">con</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_factory</span><span class="o">.</span><span class="n">make_constraint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vargs</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">con</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">UnaryConstraint</span><span class="o">.</span><span class="n">OPS</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;op&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span>
                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">d</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_factory</span><span class="o">.</span><span class="n">reference_ops</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

            <span class="n">con</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_factory</span><span class="o">.</span><span class="n">make_constraint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">con</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_constraint_paths</span><span class="p">([</span><span class="n">con</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint_dict</span><span class="p">[</span><span class="n">con</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">con</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uncoded_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">con</span></div>

<div class="viewcode-block" id="Query.where"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.where">[docs]</a>    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">cons</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new query like this one but with an additional constraint</span>
<span class="sd">        ==================================================================</span>

<span class="sd">        In contrast to add_constraint, this method returns</span>
<span class="sd">        a new object with the given comstraint added, it does not</span>
<span class="sd">        mutate the Query it is invoked on.</span>

<span class="sd">        Also available as Query.filter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">conset</span> <span class="ow">in</span> <span class="n">cons</span><span class="p">:</span>
                <span class="n">codeds</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">coded_constraints</span>
                <span class="n">lstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_logic</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span> <span class="k">if</span> <span class="n">codeds</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">start_c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">codeds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">codeds</span> <span class="k">else</span> <span class="s1">&#39;A&#39;</span>
                <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="n">conset</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="o">*</span><span class="n">con</span><span class="o">.</span><span class="n">vargs</span><span class="p">,</span> <span class="o">**</span><span class="n">con</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">set_logic</span><span class="p">(</span><span class="n">lstr</span> <span class="o">+</span> <span class="n">conset</span><span class="o">.</span><span class="n">as_logic</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="n">start_c</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">constraints</span><span class="o">.</span><span class="n">EmptyLogicError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="o">*</span><span class="n">cons</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="Query.column"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.column">[docs]</a>    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a Column object suitable for using to construct constraints with</span>
<span class="sd">        =======================================================================</span>

<span class="sd">        This method is part of the SQLAlchemy style API.</span>

<span class="sd">        Also available as Query.c</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.verify_constraint_paths"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.verify_constraint_paths">[docs]</a>    <span class="k">def</span> <span class="nf">verify_constraint_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cons</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the constraints are valid</span>
<span class="sd">        ====================================</span>

<span class="sd">        This method will check the path attribute of each constraint.</span>
<span class="sd">        In addition it will:</span>
<span class="sd">          - Check that BinaryConstraints and MultiConstraints have an Attribute as their path</span>
<span class="sd">          - Check that TernaryConstraints have a Reference as theirs</span>
<span class="sd">          - Check that SubClassConstraints have a correct subclass relationship</span>
<span class="sd">          - Check that LoopConstraints have a valid loopPath, of a compatible type</span>
<span class="sd">          - Check that ListConstraints refer to an object</span>
<span class="sd">          - Don&#39;t even try to check RangeConstraints: these have variable semantics</span>

<span class="sd">        @param cons: The constraints to check (defaults to all constraints on the query)</span>

<span class="sd">        @raise ModelError: if the paths are not valid</span>
<span class="sd">        @raise ConstraintError: if the constraints do not satisfy the above rules</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
        <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="n">cons</span><span class="p">:</span>
            <span class="n">pathA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">RangeConstraint</span><span class="p">):</span>
                <span class="k">pass</span> <span class="c1"># No verification done on these, beyond checking its path, of course.</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">IsaConstraint</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pathA</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathA</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; does not represent a class, or a reference to a class&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">con</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;Illegal constraint: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">con</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not a class in this model&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">TernaryConstraint</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pathA</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathA</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; does not represent a class, or a reference to a class&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">BinaryConstraint</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">MultiConstraint</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pathA</span><span class="o">.</span><span class="n">is_attribute</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathA</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; does not represent an attribute&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">SubClassConstraint</span><span class="p">):</span>
                <span class="n">pathB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">subclass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pathB</span><span class="o">.</span><span class="n">get_class</span><span class="p">()</span><span class="o">.</span><span class="n">isa</span><span class="p">(</span><span class="n">pathA</span><span class="o">.</span><span class="n">get_class</span><span class="p">()):</span>
                    <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">con</span><span class="o">.</span><span class="n">subclass</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not a subclass of &#39;&quot;</span> <span class="o">+</span> <span class="n">con</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">LoopConstraint</span><span class="p">):</span>
                <span class="n">pathB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">loopPath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pathA</span><span class="p">,</span> <span class="n">pathB</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">get_class</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; does not refer to an object&quot;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">classA</span><span class="p">,</span> <span class="n">classB</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pathA</span><span class="o">.</span><span class="n">get_class</span><span class="p">(),</span> <span class="n">pathB</span><span class="o">.</span><span class="n">get_class</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">classA</span><span class="o">.</span><span class="n">isa</span><span class="p">(</span><span class="n">classB</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">classB</span><span class="o">.</span><span class="n">isa</span><span class="p">(</span><span class="n">classA</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;the classes are of incompatible types: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">classA</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">classB</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">ListConstraint</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pathA</span><span class="o">.</span><span class="n">get_class</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathA</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; does not refer to an object&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the constraints of the query</span>
<span class="sd">        ====================================</span>

<span class="sd">        Query.constraints S{-&gt;} list(intermine.constraints.Constraint)</span>

<span class="sd">        Constraints are returned in the order of their code (normally</span>
<span class="sd">        the order they were added to the query) and with any</span>
<span class="sd">        subclass contraints at the end.</span>

<span class="sd">        @rtype: list(Constraint)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">con</span><span class="p">:</span> <span class="n">con</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uncoded_constraints</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="Query.get_constraint"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">get_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the constraint with the given code</span>
<span class="sd">        ==========================================</span>

<span class="sd">        Returns the constraint with the given code, if if exists.</span>
<span class="sd">        If no such constraint exists, it throws a ConstraintError</span>

<span class="sd">        @return: the constraint corresponding to the given code</span>
<span class="sd">        @rtype: L{intermine.constraints.CodedConstraint}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_dict</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;There is no constraint with the code &#39;&quot;</span>
                                    <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s2">&quot;&#39; on this query&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.add_join"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.add_join">[docs]</a>    <span class="k">def</span> <span class="nf">add_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a join statement to the query</span>
<span class="sd">        =================================</span>

<span class="sd">        example::</span>

<span class="sd">         query.add_join(&quot;Gene.proteins&quot;, &quot;OUTER&quot;)</span>

<span class="sd">        A join statement is used to determine if references should</span>
<span class="sd">        restrict the result set by only including those references</span>
<span class="sd">        exist. For example, if one had a query with the view::</span>

<span class="sd">          &quot;Gene.name&quot;, &quot;Gene.proteins.name&quot;</span>

<span class="sd">        Then in the normal case (that of an INNER join), we would only</span>
<span class="sd">        get Genes that also have at least one protein that they reference.</span>
<span class="sd">        Simply by asking for this output column you are placing a</span>
<span class="sd">        restriction on the information you get back.</span>

<span class="sd">        If in fact you wanted all genes, regardless of whether they had</span>
<span class="sd">        proteins associated with them or not, but if they did</span>
<span class="sd">        you would rather like to know _what_ proteins, then you need</span>
<span class="sd">        to specify this reference to be an OUTER join::</span>

<span class="sd">         query.add_join(&quot;Gene.proteins&quot;, &quot;OUTER&quot;)</span>

<span class="sd">        Now you will get many more rows of results, some of which will</span>
<span class="sd">        have &quot;null&quot; values where the protein name would have been,</span>

<span class="sd">        This method will also attempt to validate the join by calling</span>
<span class="sd">        Query.verify_join_paths(). Joins must have a valid path, the</span>
<span class="sd">        style can be either INNER or OUTER (defaults to OUTER,</span>
<span class="sd">        as the user does not need to specify inner joins, since all</span>
<span class="sd">        references start out as inner joins), and the path</span>
<span class="sd">        must be a reference.</span>

<span class="sd">        @raise ModelError: if the path is invalid</span>
<span class="sd">        @raise TypeError: if the join style is invalid</span>

<span class="sd">        @rtype: L{intermine.pathfeatures.Join}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">join</span> <span class="o">=</span> <span class="n">Join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">join</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_join_paths</span><span class="p">([</span><span class="n">join</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Query.outerjoin"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.outerjoin">[docs]</a>    <span class="k">def</span> <span class="nf">outerjoin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias for add_join(column, &quot;OUTER&quot;)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="s2">&quot;OUTER&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.verify_join_paths"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.verify_join_paths">[docs]</a>    <span class="k">def</span> <span class="nf">verify_join_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joins</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the joins are valid</span>
<span class="sd">        ==============================</span>

<span class="sd">        Joins must have valid paths, and they must refer to references.</span>

<span class="sd">        @raise ModelError: if the paths are invalid</span>
<span class="sd">        @raise QueryError: if the paths are not references</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">joins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">joins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joins</span>
        <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">joins</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">join</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_reference</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">QueryError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">join</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;&#39; is not a reference&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.add_path_description"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.add_path_description">[docs]</a>    <span class="k">def</span> <span class="nf">add_path_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a path description to the query</span>
<span class="sd">        ===================================</span>

<span class="sd">        example::</span>

<span class="sd">            query.add_path_description(&quot;Gene.proteins.proteinDomains&quot;, &quot;Protein Domain&quot;)</span>

<span class="sd">        This allows you to alias the components of long paths to</span>
<span class="sd">        improve the way they display column headers in a variety of circumstances.</span>
<span class="sd">        In the above example, if the view included the unwieldy path</span>
<span class="sd">        &quot;Gene.proteins.proteinDomains.primaryIdentifier&quot;, it would (depending on the</span>
<span class="sd">        mine) be displayed as &quot;Protein Domain &gt; DB Identifer&quot;. These</span>
<span class="sd">        setting are taken into account by the webservice when generating</span>
<span class="sd">        column headers for flat-file results with the columnheaders parameter given, and</span>
<span class="sd">        always supplied when requesting jsontable results.</span>

<span class="sd">        @rtype: L{intermine.pathfeatures.PathDescription}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path_description</span> <span class="o">=</span> <span class="n">PathDescription</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">path_description</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">(</span><span class="n">path_description</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_pd_paths</span><span class="p">([</span><span class="n">path_description</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_description</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path_description</span></div>

<div class="viewcode-block" id="Query.verify_pd_paths"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.verify_pd_paths">[docs]</a>    <span class="k">def</span> <span class="nf">verify_pd_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that the path of the path description is valid</span>
<span class="sd">        ====================================================</span>

<span class="sd">        Checks for consistency with the data model</span>

<span class="sd">        @raise ModelError: if the paths are invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_descriptions</span>
        <span class="k">for</span> <span class="n">pd</span> <span class="ow">in</span> <span class="n">pds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coded_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of constraints that have a code</span>
<span class="sd">        ================================================</span>

<span class="sd">        Query.coded_constraints S{-&gt;} list(intermine.constraints.CodedConstraint)</span>

<span class="sd">        This returns an up to date list of the constraints that can</span>
<span class="sd">        be used in a logic expression. The only kind of constraint</span>
<span class="sd">        that this excludes, at present, is SubClassConstraints</span>

<span class="sd">        @rtype: list(L{intermine.constraints.CodedConstraint})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">con</span><span class="p">:</span> <span class="n">con</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

<div class="viewcode-block" id="Query.get_logic"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_logic">[docs]</a>    <span class="k">def</span> <span class="nf">get_logic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the logic expression for the query</span>
<span class="sd">        ==========================================</span>

<span class="sd">        This returns the up to date logic expression. The default</span>
<span class="sd">        value is the representation of all coded constraints and&#39;ed together.</span>

<span class="sd">        If the logic is empty and there are no constraints, returns an</span>
<span class="sd">        empty string.</span>

<span class="sd">        The LogicGroup object stringifies to a string that can be parsed to</span>
<span class="sd">        obtain itself (eg: &quot;A and (B or C or D)&quot;).</span>

<span class="sd">        @rtype: L{intermine.constraints.LogicGroup}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coded_constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coded_constraints</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logic</span></div>

<div class="viewcode-block" id="Query.set_logic"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.set_logic">[docs]</a>    <span class="k">def</span> <span class="nf">set_logic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the Logic given the appropriate input</span>
<span class="sd">        ==========================================</span>

<span class="sd">        example::</span>

<span class="sd">          Query.set_logic(&quot;A and (B or C)&quot;)</span>

<span class="sd">        This sets the logic to the appropriate value. If the value is</span>
<span class="sd">        already a LogicGroup, it is accepted, otherwise</span>
<span class="sd">        the string is tokenised and parsed.</span>

<span class="sd">        The logic is then validated with a call to validate_logic()</span>

<span class="sd">        raise LogicParseError: if there is a syntax error in the logic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">LogicGroup</span><span class="p">):</span>
            <span class="n">logic</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logic_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">constraints</span><span class="o">.</span><span class="n">EmptyLogicError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coded_constraints</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_logic</span><span class="p">(</span><span class="n">logic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logic</span> <span class="o">=</span> <span class="n">logic</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Query.validate_logic"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.validate_logic">[docs]</a>    <span class="k">def</span> <span class="nf">validate_logic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logic</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the query logic</span>
<span class="sd">        =========================</span>

<span class="sd">        Attempts to validate the logic by checking</span>
<span class="sd">        that every coded_constraint is included</span>
<span class="sd">        at least once</span>

<span class="sd">        @raise QueryError: if not every coded constraint is represented</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">logic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logic</span>
        <span class="n">logic_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">logic</span><span class="o">.</span><span class="n">get_codes</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coded_constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">con</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logic_codes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QueryError</span><span class="p">(</span><span class="s2">&quot;Constraint &quot;</span> <span class="o">+</span> <span class="n">con</span><span class="o">.</span><span class="n">code</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot; is not mentioned in the logic: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">logic</span><span class="p">))</span></div>

<div class="viewcode-block" id="Query.get_default_sort_order"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_default_sort_order">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_sort_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the sort order when none has been specified</span>
<span class="sd">        ================================================</span>

<span class="sd">        This method is called to determine the sort order if</span>
<span class="sd">        none is specified</span>

<span class="sd">        @raise QueryError: if the view is empty</span>

<span class="sd">        @rtype: L{intermine.pathfeatures.SortOrderList}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joins</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;OUTER&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v0</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="n">SortOrderList</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SortOrder</span><span class="o">.</span><span class="n">ASC</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">QueryError</span><span class="p">(</span><span class="s2">&quot;Query view is empty&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.get_sort_order"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_sort_order">[docs]</a>    <span class="k">def</span> <span class="nf">get_sort_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a sort order for the query</span>
<span class="sd">        =================================</span>

<span class="sd">        This method returns the sort order if set, otherwise</span>
<span class="sd">        it returns the default sort order</span>

<span class="sd">        @raise QueryError: if the view is empty</span>

<span class="sd">        @rtype: L{intermine.pathfeatures.SortOrderList}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_sort_order</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span></div>

<div class="viewcode-block" id="Query.add_sort_order"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.add_sort_order">[docs]</a>    <span class="k">def</span> <span class="nf">add_sort_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">SortOrder</span><span class="o">.</span><span class="n">ASC</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a sort order to the query</span>
<span class="sd">        ==============================</span>

<span class="sd">        example::</span>

<span class="sd">          Query.add_sort_order(&quot;Gene.name&quot;, &quot;DESC&quot;)</span>

<span class="sd">        This method adds a sort order to the query.</span>
<span class="sd">        A query can have multiple sort orders, which are</span>
<span class="sd">        assessed in sequence.</span>

<span class="sd">        If a query has two sort-orders, for example,</span>
<span class="sd">        the first being &quot;Gene.organism.name asc&quot;,</span>
<span class="sd">        and the second being &quot;Gene.name desc&quot;, you would have</span>
<span class="sd">        the list of genes grouped by organism, with the</span>
<span class="sd">        lists within those groupings in reverse alphabetical</span>
<span class="sd">        order by gene name.</span>

<span class="sd">        This method will try to validate the sort order</span>
<span class="sd">        by calling validate_sort_order()</span>

<span class="sd">        Also available as Query.order_by</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">so</span> <span class="o">=</span> <span class="n">SortOrder</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">direction</span><span class="p">)</span>
        <span class="n">so</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_verification</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_sort_order</span><span class="p">(</span><span class="n">so</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">so</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Query.validate_sort_order"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.validate_sort_order">[docs]</a>    <span class="k">def</span> <span class="nf">validate_sort_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">so_elems</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the validity of the sort order</span>
<span class="sd">        ====================================</span>

<span class="sd">        Checks that the sort order paths are:</span>
<span class="sd">          - valid paths</span>
<span class="sd">          - in the view</span>

<span class="sd">        @raise QueryError: if the sort order is not in the view</span>
<span class="sd">        @raise ModelError: if the path is invalid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">so_elems</span><span class="p">:</span>
            <span class="n">so_elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_order_list</span>
        <span class="n">from_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_paths</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">so_elems</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">so</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">from_paths</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QueryError</span><span class="p">(</span><span class="s2">&quot;Sort order element </span><span class="si">%s</span><span class="s2"> is not in the query&quot;</span> <span class="o">%</span> <span class="n">so</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_from_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">scd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">()</span>
        <span class="n">froms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scd</span><span class="p">)</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">scd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_attribute</span><span class="p">():</span>
                <span class="n">froms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">prefix</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">froms</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">froms</span>

<div class="viewcode-block" id="Query.get_subclass_dict"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_subclass_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_subclass_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the current mapping of class to subclass</span>
<span class="sd">        ===============================================</span>

<span class="sd">        This method returns a mapping of classes used</span>
<span class="sd">        by the model for assessing whether certain paths are valid. For</span>
<span class="sd">        intance, if you subclass MicroArrayResult to be FlyAtlasResult,</span>
<span class="sd">        you can refer to the .presentCall attributes of fly atlas results.</span>
<span class="sd">        MicroArrayResults do not have this attribute, and a path such as::</span>

<span class="sd">          Gene.microArrayResult.presentCall</span>

<span class="sd">        would be marked as invalid unless the dictionary is provided.</span>

<span class="sd">        Users most likely will not need to ever call this method.</span>

<span class="sd">        @rtype: dict(string, string)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subclass_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">constraints</span><span class="o">.</span><span class="n">SubClassConstraint</span><span class="p">):</span>
                <span class="n">subclass_dict</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">subclass</span>
        <span class="k">return</span> <span class="n">subclass_dict</span></div>

<div class="viewcode-block" id="Query.results"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.results">[docs]</a>    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summary_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterator over result rows</span>
<span class="sd">        ===================================</span>

<span class="sd">        Usage::</span>

<span class="sd">          &gt;&gt;&gt; query = service.model.Gene.select(&quot;symbol&quot;, &quot;length&quot;)</span>
<span class="sd">          &gt;&gt;&gt; total = 0</span>
<span class="sd">          &gt;&gt;&gt; for gene in query.results():</span>
<span class="sd">          ...    print gene.symbol           # handle strings</span>
<span class="sd">          ...    total += gene.length        # handle numbers</span>
<span class="sd">          &gt;&gt;&gt; for row in query.results(row=&quot;rr&quot;):</span>
<span class="sd">          ...    print row[&quot;symbol&quot;]         # handle strings by dict index</span>
<span class="sd">          ...    total += row[&quot;length&quot;]      # handle numbers by dict index</span>
<span class="sd">          ...    print row[&quot;Gene.symbol&quot;]    # handle strings by full dict index</span>
<span class="sd">          ...    total += row[&quot;Gene.length&quot;] # handle numbers by full dict index</span>
<span class="sd">          ...    print row[0]                # handle strings by list index</span>
<span class="sd">          ...    total += row[1]             # handle numbers by list index</span>
<span class="sd">          &gt;&gt;&gt; for d in query.results(row=&quot;dict&quot;):</span>
<span class="sd">          ...    print row[&quot;Gene.symbol&quot;]    # handle strings</span>
<span class="sd">          ...    total += row[&quot;Gene.length&quot;] # handle numbers</span>
<span class="sd">          &gt;&gt;&gt; for l in query.results(row=&quot;list&quot;):</span>
<span class="sd">          ...    print row[0]                # handle strings</span>
<span class="sd">          ...    total += row[1]             # handle numbers</span>
<span class="sd">          &gt;&gt;&gt; import csv</span>
<span class="sd">          &gt;&gt;&gt; csv_reader = csv.reader(q.results(row=&quot;csv&quot;), delimiter=&quot;,&quot;, quotechar=&#39;&quot;&#39;)</span>
<span class="sd">          &gt;&gt;&gt; for row in csv_reader:</span>
<span class="sd">          ...    print row[0]                # handle strings</span>
<span class="sd">          ...    length_sum += int(row[1])   # handle numbers</span>
<span class="sd">          &gt;&gt;&gt; tsv_reader = csv.reader(q.results(row=&quot;tsv&quot;), delimiter=&quot;\t&quot;)</span>
<span class="sd">          &gt;&gt;&gt; for row in tsv_reader:</span>
<span class="sd">          ...    print row[0]                # handle strings</span>
<span class="sd">          ...    length_sum += int(row[1])   # handle numbers</span>

<span class="sd">        This is the general method that allows access to any of the available</span>
<span class="sd">        result formats. The example above shows the ways these differ in terms</span>
<span class="sd">        of accessing fields of the rows, as well as dealing with different</span>
<span class="sd">        data types. Results can either be retrieved as typed values (jsonobjects,</span>
<span class="sd">        rr [&#39;ResultRows&#39;], dict, list), or as lists of strings (csv, tsv) which then require</span>
<span class="sd">        further parsing. The default format for this method is &quot;objects&quot;, where</span>
<span class="sd">        information is grouped by its relationships. The other main format is</span>
<span class="sd">        &quot;rr&quot;, which stands for &#39;ResultRows&#39;, and can be accessed directly through</span>
<span class="sd">        the L{rows} method.</span>

<span class="sd">        Note that when requesting object based results (the default), if your query</span>
<span class="sd">        contains any kind of collection, it is highly likely that start and size won&#39;t do what</span>
<span class="sd">        you think, as they operate only on the underlying</span>
<span class="sd">        rows used to build up the returned objects. If you want rows</span>
<span class="sd">        back, you are recommeded to use the simpler rows method.</span>

<span class="sd">        If no views have been specified, all attributes of the root class</span>
<span class="sd">        are selected for output.</span>

<span class="sd">        @param row: The format for each result. One of &quot;object&quot;, &quot;rr&quot;,</span>
<span class="sd">                    &quot;dict&quot;, &quot;list&quot;, &quot;tsv&quot;, &quot;csv&quot;, &quot;jsonrows&quot;, &quot;jsonobjects&quot;</span>
<span class="sd">        @type row: string</span>
<span class="sd">        @param start: the index of the first result to return (default = 0)</span>
<span class="sd">        @type start: int</span>
<span class="sd">        @param size: The maximum number of results to return (default = all)</span>
<span class="sd">        @type size: int</span>
<span class="sd">        @param summary_path: A column name to optionally summarise. Specifying a path</span>
<span class="sd">                             will force &quot;jsonrows&quot; format, and return an iterator over a list</span>
<span class="sd">                             of dictionaries. Use this when you are interested in processing</span>
<span class="sd">                             a summary in order of greatest count to smallest.</span>
<span class="sd">        @type summary_path: str or L{intermine.model.Path}</span>

<span class="sd">        @rtype: L{intermine.webservice.ResultIterator}</span>

<span class="sd">        @raise WebserviceError: if the request is unsuccessful</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">to_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_run</span><span class="o">.</span><span class="n">views</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">to_run</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">to_run</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;object&quot;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coded_constraints</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">to_run</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">_path</span>
                <span class="n">from_p</span> <span class="o">=</span> <span class="n">p</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">end_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">to_run</span><span class="o">.</span><span class="n">views</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">from_p</span><span class="p">))]:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_attribute</span><span class="p">():</span>
                        <span class="n">to_run</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">to_run</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">to_run</span><span class="o">.</span><span class="n">get_results_path</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">to_run</span><span class="o">.</span><span class="n">to_query_params</span><span class="p">()</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">if</span> <span class="n">summary_path</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;summaryPath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_run</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">(</span><span class="n">summary_path</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="s2">&quot;jsonrows&quot;</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">to_run</span><span class="o">.</span><span class="n">views</span>
        <span class="n">cld</span> <span class="o">=</span> <span class="n">to_run</span><span class="o">.</span><span class="n">root</span>
        <span class="k">return</span> <span class="n">to_run</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">cld</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.rows"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.rows">[docs]</a>    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the results as rows of data</span>
<span class="sd">        ==================================</span>

<span class="sd">        This is a shortcut for results(&quot;rr&quot;)</span>

<span class="sd">        Usage::</span>

<span class="sd">          &gt;&gt;&gt; for row in query.rows(start=10, size=10):</span>
<span class="sd">          ...     print row[&quot;proteins.name&quot;]</span>

<span class="sd">        @param start: the index of the first result to return (default = 0)</span>
<span class="sd">        @type start: int</span>
<span class="sd">        @param size: The maximum number of results to return (default = all)</span>
<span class="sd">        @type size: int</span>
<span class="sd">        @rtype: iterable&lt;intermine.webservice.ResultRow&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="s2">&quot;rr&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.summarise"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.summarise">[docs]</a>    <span class="k">def</span> <span class="nf">summarise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a summary of the results for this column.</span>
<span class="sd">        ================================================</span>

<span class="sd">        Usage::</span>
<span class="sd">            &gt;&gt;&gt; query = service.select(&quot;Gene.*&quot;, &quot;organism.*&quot;).where(&quot;Gene&quot;, &quot;IN&quot;, &quot;my-list&quot;)</span>
<span class="sd">            &gt;&gt;&gt; print query.summarise(&quot;length&quot;)[&quot;average&quot;]</span>
<span class="sd">            ... 12345.67890</span>
<span class="sd">            &gt;&gt;&gt; print query.summarise(&quot;organism.name&quot;)[&quot;Drosophila simulans&quot;]</span>
<span class="sd">            ... 98</span>

<span class="sd">        This method allows you to get statistics summarising the information</span>
<span class="sd">        from just one column of a query. For numerical columns you get dictionary with</span>
<span class="sd">        four keys (&#39;average&#39;, &#39;stdev&#39;, &#39;max&#39;, &#39;min&#39;), and for non-numerical</span>
<span class="sd">        columns you get a dictionary where each item is a key and the values</span>
<span class="sd">        are the number of occurrences of this value in the column.</span>

<span class="sd">        Any key word arguments will be passed to the underlying results call -</span>
<span class="sd">        so you can limit the result size to the top 100 items by passing &quot;size = 100&quot;</span>
<span class="sd">        as part of the call.</span>

<span class="sd">        @see: L{intermine.query.Query.results}</span>

<span class="sd">        @param summary_path: The column to summarise (either in long or short form)</span>
<span class="sd">        @type summary_path: str or L{intermine.model.Path}</span>

<span class="sd">        @rtype: dict</span>
<span class="sd">        This method is sugar for particular combinations of calls to L{results}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_path</span><span class="p">(</span><span class="n">summary_path</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subclass_dict</span><span class="p">())</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">summary_path</span> <span class="o">=</span> <span class="n">summary_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">type_name</span> <span class="ow">in</span> <span class="n">Model</span><span class="o">.</span><span class="n">NUMERIC_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.one"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.one">[docs]</a>    <span class="k">def</span> <span class="nf">one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;jsonobjects&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return one result, and raise an error if the result size is not 1&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="s2">&quot;jsonobjects&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">QueryError</span><span class="p">(</span><span class="s2">&quot;More than one result received&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">QueryError</span><span class="p">(</span><span class="s2">&quot;No results received&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">ret</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">QueryError</span><span class="p">(</span><span class="s2">&quot;Result size is not one: got </span><span class="si">%d</span><span class="s2"> results&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.first"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.first">[docs]</a>    <span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;jsonobjects&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the first result, or None if the results are empty&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="s2">&quot;jsonobjects&quot;</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Query.get_results_list"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_results_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of result rows</span>
<span class="sd">        =========================</span>

<span class="sd">        This method is a shortcut so that you do not have to</span>
<span class="sd">        do a list comprehension yourself on the iterator that</span>
<span class="sd">        is normally returned. If you have a very large result</span>
<span class="sd">        set (and these can get up to 100&#39;s of thousands or rows</span>
<span class="sd">        pretty easily) you will not want to</span>
<span class="sd">        have the whole list in memory at once, but there may</span>
<span class="sd">        be other circumstances when you might want to keep the whole</span>
<span class="sd">        list in one place.</span>

<span class="sd">        It takes all the same arguments and parameters as Query.results</span>

<span class="sd">        Also available as Query.all</span>

<span class="sd">        @see: L{intermine.query.Query.results}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="Query.get_row_list"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_row_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_row_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results_list</span><span class="p">(</span><span class="s2">&quot;rr&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.count"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the total number of rows this query returns</span>
<span class="sd">        ==================================================</span>

<span class="sd">        Obtain the number of rows a particular query will</span>
<span class="sd">        return, without having to fetch and parse all the</span>
<span class="sd">        actual data. This method makes a request to the server</span>
<span class="sd">        to report the count for the query, and is sugar for a</span>
<span class="sd">        results call.</span>

<span class="sd">        Also available as Query.size</span>

<span class="sd">        @rtype: int</span>
<span class="sd">        @raise WebserviceError: if the request is unsuccessful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">):</span>
            <span class="n">count_str</span> <span class="o">+=</span> <span class="n">row</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">count_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResultError</span><span class="p">(</span><span class="s2">&quot;Server returned a non-integer count: &quot;</span> <span class="o">+</span> <span class="n">count_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.get_list_upload_uri"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_list_upload_uri">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_upload_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the uri to use to create a list from this query</span>
<span class="sd">        =======================================================</span>

<span class="sd">        Query.get_list_upload_uri() -&gt; str</span>

<span class="sd">        This method is used internally when performing list operations</span>
<span class="sd">        on queries.</span>

<span class="sd">        @rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">QUERY_LIST_UPLOAD_PATH</span></div>

<div class="viewcode-block" id="Query.get_list_append_uri"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_list_append_uri">[docs]</a>    <span class="k">def</span> <span class="nf">get_list_append_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the uri to use to create a list from this query</span>
<span class="sd">        =======================================================</span>

<span class="sd">        Query.get_list_append_uri() -&gt; str</span>

<span class="sd">        This method is used internally when performing list operations</span>
<span class="sd">        on queries.</span>

<span class="sd">        @rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">QUERY_LIST_APPEND_PATH</span></div>


<div class="viewcode-block" id="Query.get_results_path"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.get_results_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path section pointing to the REST resource</span>
<span class="sd">        ======================================================</span>

<span class="sd">        Query.get_results_path() -&gt; str</span>

<span class="sd">        Internally, this just calls a constant property</span>
<span class="sd">        in intermine.service.Service</span>

<span class="sd">        @rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">QUERY_PATH</span></div>


<div class="viewcode-block" id="Query.children"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.children">[docs]</a>    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the child objects of the query</span>
<span class="sd">        ======================================</span>

<span class="sd">        This method is used during the serialisation of queries</span>
<span class="sd">        to xml. It is unlikely you will need access to this as a whole.</span>
<span class="sd">        Consider using &quot;path_descriptions&quot;, &quot;joins&quot;, &quot;constraints&quot; instead</span>

<span class="sd">        @see: Query.path_descriptions</span>
<span class="sd">        @see: Query.joins</span>
<span class="sd">        @see: Query.constraints</span>

<span class="sd">        @return: the child element of this query</span>
<span class="sd">        @rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">path_descriptions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">],</span> <span class="p">[])</span></div>

<div class="viewcode-block" id="Query.to_query"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.to_query">[docs]</a>    <span class="k">def</span> <span class="nf">to_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementation of trait that allows use of these objects as queries (casting).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Query.make_list_constraint"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.make_list_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">make_list_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementation of trait that allows use of these objects in list constraints</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">create_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ConstraintNode</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Query.to_query_params"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.to_query_params">[docs]</a>    <span class="k">def</span> <span class="nf">to_query_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the parameters to be passed to the webservice</span>
<span class="sd">        =====================================================</span>

<span class="sd">        The query is responsible for producing its own query</span>
<span class="sd">        parameters. These consist simply of:</span>
<span class="sd">         - query: the xml representation of the query</span>

<span class="sd">        @rtype: dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query&#39;</span> <span class="p">:</span> <span class="n">xml</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="Query.to_Node"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.to_Node">[docs]</a>    <span class="k">def</span> <span class="nf">to_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a DOM node representing the query</span>
<span class="sd">        =========================================</span>

<span class="sd">        This is an intermediate step in the creation of the</span>
<span class="sd">        xml serialised version of the query. You probably</span>
<span class="sd">        won&#39;t need to call this directly.</span>

<span class="sd">        @rtype: xml.minidom.Node</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">impl</span>  <span class="o">=</span> <span class="n">getDOMImplementation</span><span class="p">()</span>
        <span class="n">doc</span>   <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">createDocument</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">documentElement</span>

        <span class="n">query</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">views</span><span class="p">))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">&#39;sortOrder&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_sort_order</span><span class="p">()))</span>
        <span class="n">query</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">&#39;longDescription&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coded_constraints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s1">&#39;constraintLogic&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_logic</span><span class="p">()))</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">child_type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">subelement</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">createTextNode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">subelement</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">subelement</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="Query.to_xml"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.to_xml">[docs]</a>    <span class="k">def</span> <span class="nf">to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an XML serialisation of the query</span>
<span class="sd">        ========================================</span>

<span class="sd">        This method serialises the current state of the query to an</span>
<span class="sd">        xml string, suitable for storing, or sending over the</span>
<span class="sd">        internet to the webservice.</span>

<span class="sd">        @return: the serialised xml string</span>
<span class="sd">        @rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_Node</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">toxml</span><span class="p">()</span></div>

<div class="viewcode-block" id="Query.to_formatted_xml"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.to_formatted_xml">[docs]</a>    <span class="k">def</span> <span class="nf">to_formatted_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a readable XML serialisation of the query</span>
<span class="sd">        ================================================</span>

<span class="sd">        This method serialises the current state of the query to an</span>
<span class="sd">        xml string, suitable for storing, or sending over the</span>
<span class="sd">        internet to the webservice, only more readably.</span>

<span class="sd">        @return: the serialised xml string</span>
<span class="sd">        @rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_Node</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">toprettyxml</span><span class="p">()</span></div>

<div class="viewcode-block" id="Query.clone"><a class="viewcode-back" href="../../intermine.html#intermine.query.Query.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a deep clone</span>
<span class="sd">        =====================</span>

<span class="sd">        This method will produce a clone that is independent,</span>
<span class="sd">        and can be altered without affecting the original,</span>
<span class="sd">        but starts off with the exact same state as it.</span>

<span class="sd">        The only shared elements should be the model</span>
<span class="sd">        and the service, which are shared by all queries</span>
<span class="sd">        that refer to the same webservice.</span>

<span class="sd">        @return: same class as caller</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;joins&quot;</span><span class="p">,</span> <span class="s2">&quot;views&quot;</span><span class="p">,</span> <span class="s2">&quot;_sort_order_list&quot;</span><span class="p">,</span> <span class="s2">&quot;_logic&quot;</span><span class="p">,</span> <span class="s2">&quot;path_descriptions&quot;</span><span class="p">,</span> <span class="s2">&quot;constraint_dict&quot;</span><span class="p">,</span> <span class="s2">&quot;uncoded_constraints&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;service&quot;</span><span class="p">,</span> <span class="s2">&quot;do_verification&quot;</span><span class="p">,</span> <span class="s2">&quot;constraint_factory&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">newobj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">newobj</span></div></div>

<div class="viewcode-block" id="Template"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template">[docs]</a><span class="k">class</span> <span class="nc">Template</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Class representing a predefined query</span>
<span class="sd">    =======================================</span>

<span class="sd">    Templates are ways of saving queries</span>
<span class="sd">    and allowing others to run them</span>
<span class="sd">    simply. They are the main interface</span>
<span class="sd">    to querying in the webapp</span>

<span class="sd">    SYNOPSIS</span>
<span class="sd">    --------</span>

<span class="sd">    example::</span>

<span class="sd">      service = Service(&quot;http://www.flymine.org/query/service&quot;)</span>
<span class="sd">      template = service.get_template(&quot;Gene_Pathways&quot;)</span>
<span class="sd">      for row in template.results(A={&quot;value&quot;:&quot;eve&quot;}):</span>
<span class="sd">        process_row(row)</span>
<span class="sd">        ...</span>

<span class="sd">    A template is a subclass of query that comes predefined. They</span>
<span class="sd">    are typically retrieved from the webservice and run by specifying</span>
<span class="sd">    the values for their existing constraints. They are a concise</span>
<span class="sd">    and powerful way of running queries in the webapp.</span>

<span class="sd">    Being subclasses of query, everything is true of them that is true</span>
<span class="sd">    of a query. They are just less work, as you don&#39;t have to design each</span>
<span class="sd">    one. Also, you can store your own templates in the web-app, and then</span>
<span class="sd">    access them as a private webservice method, from anywhere, making them</span>
<span class="sd">    a kind of query in the cloud - for this you will need to authenticate</span>
<span class="sd">    by providing log in details to the service.</span>

<span class="sd">    The most significant difference is how constraint values are specified</span>
<span class="sd">    for each set of results.</span>

<span class="sd">    @see: L{Template.results}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        ===========</span>

<span class="sd">        Instantiation is identical that of queries. As with queries,</span>
<span class="sd">        these are best obtained from the intermine.webservice.Service</span>
<span class="sd">        factory methods.</span>

<span class="sd">        @see: L{intermine.webservice.Service.get_template}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Template</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_factory</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">TemplateConstraintFactory</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">editable_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of constraints you can edit</span>
<span class="sd">        ===========================================</span>

<span class="sd">        Template.editable_constraints -&gt; list(intermine.constraints.Constraint)</span>

<span class="sd">        Templates have a concept of editable constraints, which</span>
<span class="sd">        is a way of hiding complexity from users. An underlying query may have</span>
<span class="sd">        five constraints, but only expose the one that is actually</span>
<span class="sd">        interesting. This property returns this subset of constraints</span>
<span class="sd">        that have the editable flag set to true.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">editable</span><span class="p">]</span>

<div class="viewcode-block" id="Template.to_query_params"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.to_query_params">[docs]</a>    <span class="k">def</span> <span class="nf">to_query_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the query parameters needed for the webservice</span>
<span class="sd">        ======================================================</span>

<span class="sd">        Template.to_query_params() -&gt; dict(string, string)</span>

<span class="sd">        Overrides the method of the same name in query to provide the</span>
<span class="sd">        parameters needed by the templates results service. These</span>
<span class="sd">        are slightly more complex:</span>
<span class="sd">            - name: The template&#39;s name</span>
<span class="sd">            - for each constraint: (where [i] is an integer incremented for each constraint)</span>
<span class="sd">                - constraint[i]: the path</span>
<span class="sd">                - op[i]:         the operator</span>
<span class="sd">                - value[i]:      the value</span>
<span class="sd">                - code[i]:       the code</span>
<span class="sd">                - extra[i]:      the extra value for ternary constraints (optional)</span>


<span class="sd">        @rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">editable_constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">switched_on</span><span class="p">:</span> <span class="nb">next</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;extraValue&quot;</span><span class="p">:</span> <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;extra&quot;</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;constraint&quot;</span>
                <span class="n">p</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="Template.get_results_path"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.get_results_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path section pointing to the REST resource</span>
<span class="sd">        ======================================================</span>

<span class="sd">        Template.get_results_path() S{-&gt;} str</span>

<span class="sd">        Internally, this just calls a constant property</span>
<span class="sd">        in intermine.service.Service</span>

<span class="sd">        This overrides the method of the same name in Query</span>

<span class="sd">        @return: the path to the REST resource</span>
<span class="sd">        @rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">TEMPLATEQUERY_PATH</span></div>

<div class="viewcode-block" id="Template.get_adjusted_template"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.get_adjusted_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_adjusted_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">con_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a template to run</span>
<span class="sd">        ======================</span>

<span class="sd">        Template.get_adjusted_template(con_values) S{-&gt;} Template</span>

<span class="sd">        When templates are run, they are first cloned, and their</span>
<span class="sd">        values are changed to those desired. This leaves the original</span>
<span class="sd">        template unchanged so it can be run again with different</span>
<span class="sd">        values. This method does the cloning and changing of constraint</span>
<span class="sd">        values</span>

<span class="sd">        @raise ConstraintError: if the constraint values specify values for a non-editable constraint.</span>

<span class="sd">        @rtype: L{Template}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">con_values</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">con</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">get_constraint</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">con</span><span class="o">.</span><span class="n">editable</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="s2">&quot;There is a constraint &#39;&quot;</span> <span class="o">+</span> <span class="n">code</span>
                                       <span class="o">+</span> <span class="s2">&quot;&#39; on this query, but it is not editable&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clone</span></div>

<div class="viewcode-block" id="Template.results"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.results">[docs]</a>    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">con_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get an iterator over result rows</span>
<span class="sd">        ================================</span>

<span class="sd">        This method returns the same values with the</span>
<span class="sd">        same options as the method of the same name in</span>
<span class="sd">        Query (see intermine.query.Query). The main difference in in the</span>
<span class="sd">        arguments.</span>

<span class="sd">        The template result methods also accept a key-word pair</span>
<span class="sd">        set of arguments that are used to supply values</span>
<span class="sd">        to the editable constraints. eg::</span>

<span class="sd">          template.results(</span>
<span class="sd">            A = {&quot;value&quot;: &quot;eve&quot;},</span>
<span class="sd">            B = {&quot;op&quot;: &quot;&gt;&quot;, &quot;value&quot;: 5000}</span>
<span class="sd">          )</span>

<span class="sd">        The keys should be codes for editable constraints (you can inspect these</span>
<span class="sd">        with Template.editable_constraints) and the values should be a dictionary</span>
<span class="sd">        of constraint properties to replace. You can replace the values for</span>
<span class="sd">        &quot;op&quot; (operator), &quot;value&quot;, and &quot;extra_value&quot; and &quot;values&quot; in the case of</span>
<span class="sd">        ternary and multi constraints.</span>

<span class="sd">        @rtype: L{intermine.webservice.ResultIterator}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adjusted_template</span><span class="p">(</span><span class="n">con_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Template</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Template.get_results_list"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.get_results_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_results_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">con_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of result rows</span>
<span class="sd">        =========================</span>

<span class="sd">        This method performs the same as the method of the</span>
<span class="sd">        same name in Query, and it shares the semantics of</span>
<span class="sd">        Template.results().</span>

<span class="sd">        @see: L{intermine.query.Query.get_results_list}</span>
<span class="sd">        @see: L{intermine.query.Template.results}</span>

<span class="sd">        @rtype: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adjusted_template</span><span class="p">(</span><span class="n">con_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Template</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span><span class="o">.</span><span class="n">get_results_list</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Template.get_row_list"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.get_row_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_row_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">con_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of the rows returned by this query&quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adjusted_template</span><span class="p">(</span><span class="n">con_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Template</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span><span class="o">.</span><span class="n">get_row_list</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Template.rows"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.rows">[docs]</a>    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">con_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get an iterator over the rows returned by this query&quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adjusted_template</span><span class="p">(</span><span class="n">con_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Template</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span><span class="o">.</span><span class="n">rows</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Template.count"><a class="viewcode-back" href="../../intermine.html#intermine.query.Template.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">con_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the total number of rows this template returns</span>
<span class="sd">        =====================================================</span>

<span class="sd">        Obtain the number of rows a particular query will</span>
<span class="sd">        return, without having to fetch and parse all the</span>
<span class="sd">        actual data. This method makes a request to the server</span>
<span class="sd">        to report the count for the query, and is sugar for a</span>
<span class="sd">        results call.</span>

<span class="sd">        @rtype: int</span>
<span class="sd">        @raise WebserviceError: if the request is unsuccessful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adjusted_template</span><span class="p">(</span><span class="n">con_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Template</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="QueryError"><a class="viewcode-back" href="../../intermine.html#intermine.query.QueryError">[docs]</a><span class="k">class</span> <span class="nc">QueryError</span><span class="p">(</span><span class="n">ReadableException</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ConstraintError"><a class="viewcode-back" href="../../intermine.html#intermine.query.ConstraintError">[docs]</a><span class="k">class</span> <span class="nc">ConstraintError</span><span class="p">(</span><span class="n">QueryError</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="QueryParseError"><a class="viewcode-back" href="../../intermine.html#intermine.query.QueryParseError">[docs]</a><span class="k">class</span> <span class="nc">QueryParseError</span><span class="p">(</span><span class="n">QueryError</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="ResultError"><a class="viewcode-back" href="../../intermine.html#intermine.query.ResultError">[docs]</a><span class="k">class</span> <span class="nc">ResultError</span><span class="p">(</span><span class="n">ReadableException</span><span class="p">):</span>
    <span class="k">pass</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../query.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Alex Kalderimis, Julie Sullivan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>